---
- name: apply security patch
  hosts: idm_nodes
  tags: idm_data_crypt 
  vars:
    curr_pwd: "Password123!"
    new_pwd: "openidm-admin"
    temp_output: /tmp/output.tmp
    final_output: /tmp/output.json

  tasks:
    - name: Get current password
      shell: |
        echo "current password is {{ curr_pwd }}"

    - name: Get new password
      shell: echo "new password is {{ new_pwd }}"  

    - name: Encrypt new password
      shell: |
        /opt/openidm/cli.sh secureHash "{{ new_pwd }}" |
        egrep -v 'Starting|Executing|\-BEGIN|\-END' |
        tr -d '\n' | tr -d ' '
      register: encrypted

    - name: Copy content to file
      copy:
        content: "{{ encrypted.stdout }}"
        dest: "{{ temp_output }}" 
        mode: 0400

    - name: Get internaluser
      uri:
        url: 'https://localhost:9443/openidm/internal/user/openidm-admin?_prettyPrint=true'
        headers:
          X-OpenIDM-Username: openidm-admin
          X-OpenIDM-Password: "{{ curr_pwd }}"
        method: GET 
      register: getUrlOut

    - name: Copy json response to file
      copy:
        content: "{{ getUrlOut.json }}"
        dest: "{{ final_output }}" 
        mode: 0600

    - name: Modify json content 
      lineinfile: 
        dest: "{{ final_output }}" 
        regexp: '(.*)("password".*)("roles".*)'
        line: '\g<1>"password": {{ encrypted.stdout }}, \g<3>' 
        backrefs: true
      register: replContent

    - name: read from file
      shell: cat "{{ final_output }}"
      register: json_body

    - name: Update internaluser record
      uri:
        url: 'https://localhost:9443/openidm/internal/user/openidm-admin?_prettyPrint=true'
        headers:
          X-OpenIDM-Username: 'openidm-admin'
          X-OpenIDM-Password: "{{ curr_pwd }}"
        method: PUT
        body_format: json
        body: "{{ json_body.stdout }}"
      register: putUrlOut
